<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>okGARAGE v1.1.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        
        :root {
            --bg-dark: #050505;
            --glass-panel: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: 12px;
            --accent: #a855f7;
            --radius-xl: 32px;
            
            /* EXPANDED RANK PALETTE */
            --rank-iron: #546e7a;
            --rank-bronze: #cd7f32;
            --rank-silver: #e5e7eb;
            --rank-gold: #fbbf24;
            --rank-platinum: #22d3ee;
            --rank-emerald: #10b981;
            --rank-sapphire: #3b82f6;
            --rank-amethyst: #a855f7;
            --rank-ruby: #f43f5e;
            --rank-topaz: #f97316;
            --rank-obsidian: #ffffff; /* White glow on black */
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #bg-layer {
            position: absolute; inset: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, #2e1065 0%, transparent 60%),
                        conic-gradient(from 0deg at 50% 50%, #000, #1e1b4b, #000);
            opacity: 0.5; z-index: -2; animation: spin 180s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        .smooth-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            padding: 10px 20px; border-radius: 99px; font-weight: 600; font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 8px; cursor: pointer; outline: none;
        }
        .smooth-btn:hover { background: rgba(255,255,255,0.15); transform: scale(1.05); }
        .smooth-btn.primary { background: var(--accent); color: black; border-color: var(--accent); box-shadow: 0 0 25px rgba(168, 85, 247, 0.4); }
        .smooth-btn.danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border-color: rgba(239, 68, 68, 0.4); }
        .smooth-btn.active-mode { background: #fbbf24; color: black; border-color: #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }

        .top-bar { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .version-tag { font-family: 'JetBrains Mono', monospace; font-size: 10px; opacity: 0.4; letter-spacing: 1px; margin-left: 8px; border: 1px solid rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; }

        /* XP BAR & RANK STYLES */
        .xp-container { display: flex; align-items: center; gap: 15px; width: 350px; }
        
        .rank-icon-box {
            width: 54px; height: 54px; border-radius: 14px;
            background: rgba(0,0,0,0.3); border: 2px solid;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; transition: 0.3s;
        }
        .rank-icon-box img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }

        .xp-details { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .xp-text-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .rank-name { font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; line-height: 1; }
        .rank-tier { font-size: 10px; opacity: 0.6; font-weight: 700; margin-left: 6px; font-family: 'JetBrains Mono'; }
        .xp-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; }
        .xp-fill { height: 100%; width: 0%; background: var(--accent); border-radius: 99px; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* --- RANK COLOR CLASSES --- */
        .rank-iron { border-color: var(--rank-iron); color: var(--rank-iron); box-shadow: inset 0 0 10px rgba(84, 110, 122, 0.2); }
        .rank-bronze { border-color: var(--rank-bronze); color: var(--rank-bronze); box-shadow: 0 0 10px rgba(205, 127, 50, 0.2); }
        .rank-silver { border-color: var(--rank-silver); color: var(--rank-silver); text-shadow: 0 0 10px white; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .rank-gold { border-color: var(--rank-gold); color: var(--rank-gold); text-shadow: 0 0 10px var(--rank-gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        .rank-platinum { border-color: var(--rank-platinum); color: var(--rank-platinum); text-shadow: 0 0 10px var(--rank-platinum); box-shadow: 0 0 20px rgba(34, 211, 238, 0.4); }
        .rank-emerald { border-color: var(--rank-emerald); color: var(--rank-emerald); text-shadow: 0 0 10px var(--rank-emerald); box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        .rank-sapphire { border-color: var(--rank-sapphire); color: var(--rank-sapphire); text-shadow: 0 0 15px var(--rank-sapphire); box-shadow: 0 0 25px rgba(59, 130, 246, 0.5); }
        .rank-amethyst { border-color: var(--rank-amethyst); color: var(--rank-amethyst); text-shadow: 0 0 15px var(--rank-amethyst); box-shadow: 0 0 25px rgba(168, 85, 247, 0.5); }
        .rank-ruby { border-color: var(--rank-ruby); color: var(--rank-ruby); text-shadow: 0 0 20px var(--rank-ruby); box-shadow: 0 0 30px rgba(244, 63, 94, 0.6); }
        .rank-topaz { border-color: var(--rank-topaz); color: var(--rank-topaz); text-shadow: 0 0 20px var(--rank-topaz); box-shadow: 0 0 30px rgba(249, 115, 22, 0.6); }
        .rank-obsidian { border-color: #333; color: white; background: #000; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .rank-chroma { border-color: white; background: linear-gradient(135deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f); animation: hue 5s infinite linear; }
        
        @keyframes hue { from{filter: hue-rotate(0deg);} to{filter: hue-rotate(360deg);} }

        /* GRID & CARDS */
        .grid-container { flex: 1; overflow-y: auto; padding: 20px 40px 100px 40px; display: grid; grid-template-columns: 1fr; align-content: start; gap: 12px; max-width: 1000px; margin: 0 auto; width: 100%; }
        .car-card { border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-xl); cursor: pointer; transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.4s; position: relative; overflow: hidden; height: 160px; display: flex; flex-direction: column; justify-content: space-between; user-select: none; }
        .car-card:hover { transform: scale(1.02); border-color: var(--accent); box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 10; }
        body.edit-mode .car-card { cursor: move !important; border-color: #fbbf24; border-style: dashed; }
        body.edit-mode .car-card:hover { transform: none; }
        body.edit-mode .card-content { pointer-events: none; opacity: 0.5; }
        .bg-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; transition: transform 0.6s ease; object-position: center; }
        .car-card:hover .bg-img { transform: scale(1.05); }
        body.edit-mode .bg-img { transition: none; transform: none !important; }
        .card-gradient { position: absolute; inset: 0; background: linear-gradient(90deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 40%, transparent 100%); z-index: 1; }
        .card-content { position: relative; z-index: 2; padding: 24px 30px; height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; }
        .card-name { font-size: 28px; font-weight: 800; color: white; line-height: 1; margin-bottom: 6px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .card-real { font-size: 12px; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .card-stats { display: flex; gap: 15px; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.6); }
        .stat-badge { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 8px; display: flex; align-items: center; gap: 6px; }

        /* OVERLAYS */
        .overlay { position: fixed; inset: 0; background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(20px); z-index: 100; opacity: 0; pointer-events: none; transition: 0.4s; display: flex; align-items: center; justify-content: center; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .detail-panel { width: 900px; max-width: 95vw; background: rgba(20, 20, 25, 0.6); border: 1px solid var(--glass-border); border-radius: 40px; padding: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; transform: scale(0.95); transition: 0.4s; position: relative; }
        .overlay.active .detail-panel { transform: scale(1); }
        .close-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; outline: none; }
        .close-btn:hover { background: white; color: black; }
        .detail-img-box { border-radius: 32px; overflow: hidden; border: 1px solid var(--glass-border); aspect-ratio: 4/3; background: black; position: relative; }
        .detail-info { position: relative; display: flex; flex-direction: column; justify-content: center; } 
        .detail-info h1 { font-size: 42px; font-weight: 900; line-height: 1; margin-bottom: 5px; }
        .detail-info h2 { font-size: 16px; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }
        .stat-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .big-stat { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 24px; flex: 1; border: 1px solid var(--glass-border); text-align: center; position: relative; transition: 0.2s; }
        .big-stat.editable:hover { background: rgba(255,255,255,0.08); cursor: text; border-color: var(--accent); }
        .big-stat-val { font-size: 32px; font-weight: 800; font-family: 'JetBrains Mono'; }
        .big-stat-label { font-size: 11px; text-transform: uppercase; opacity: 0.5; font-weight: 700; margin-top: 4px; }
        .stat-input { width: 100%; background: transparent; color: white; font-family: 'JetBrains Mono'; font-size: 32px; font-weight: 800; text-align: center; outline: none; border: none; display: none; -moz-appearance: textfield; }
        .stat-input::-webkit-outer-spin-button, .stat-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Mastery Header */
        .mastery-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .mastery-icon { width: 34px; height: 34px; border-radius: 10px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 1px solid; overflow: hidden; }
        .mastery-icon img { width: 100%; height: 100%; object-fit: contain; padding: 2px; }
        .car-xp-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; margin-bottom: 30px; position: relative; }
        .car-xp-fill { height: 100%; background: var(--accent); width: 0%; box-shadow: 0 0 15px var(--accent); transition: width 0.5s ease; }

        .car-tasks-panel { position: absolute; inset: 0; background: rgba(20,20,25,0.98); border-radius: 40px; padding: 40px; z-index: 20; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transform: scale(0.95); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .car-tasks-panel.open { opacity: 1; pointer-events: auto; transform: scale(1); }
        .task-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .task-item:hover { border-color: var(--accent); }

        #toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%) translateY(-50px); background: rgba(20, 20, 30, 0.8); border: 1px solid var(--accent); backdrop-filter: blur(15px); padding: 12px 24px; border-radius: 99px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 1000; opacity: 0; transition: all 0.4s; pointer-events: none; }
        #toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-icon { color: var(--accent); font-size: 16px; }
        .toast-msg { font-size: 13px; font-weight: 700; color: white; }

        #lvlUpOverlay { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.5s; }
        #lvlUpOverlay.active { opacity: 1; pointer-events: auto; }
        .lvl-up-card { text-align: center; transform: scale(0.5); opacity: 0; transition: 0.5s; }
        #lvlUpOverlay.active .lvl-up-card { transform: scale(1); opacity: 1; }
        .lvl-glow { width: 300px; height: 300px; background: radial-gradient(circle, var(--accent) 0%, transparent 70%); position: absolute; z-index: -1; opacity: 0.5; animation: spin 10s linear infinite; }

        .img-edit-container { width: 100%; height: 180px; background: #111; border-radius: 20px; overflow: hidden; position: relative; border: 2px dashed rgba(255,255,255,0.1); margin-top: 10px; cursor: grab; }
        .img-edit-container:active { cursor: grabbing; border-color: var(--accent); }
        .img-preview { width: 100%; height: 100%; object-fit: cover; pointer-events: none; user-select: none; }
        .drag-hint { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 700; pointer-events: none; opacity: 0.8; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <!-- TOP NAV -->
    <div class="top-bar">
        <div class="text-2xl font-black tracking-tighter flex items-center">
            ok<span style="color:var(--accent)">GARAGE</span>
            <span class="version-tag">v1.1.6</span>
        </div>
        
        <div class="flex items-center gap-6">
            <!-- NEW XP BAR -->
            <div class="xp-container">
                <div class="rank-icon-box rank-iron" id="mainRankIcon">
                    <img id="mainRankImg" src="" alt="Rank">
                </div>
                <div class="xp-details">
                    <div class="xp-text-row">
                        <div>
                            <span id="rankTitle" class="rank-name">IRON</span>
                            <span id="rankTier" class="rank-tier">I</span>
                        </div>
                        <span style="font-size:10px; opacity:0.5;">LVL <span id="mainLvl">1</span></span>
                    </div>
                    <div class="xp-track">
                        <div class="xp-fill" id="mainXpFill"></div>
                    </div>
                </div>
            </div>

            <button id="imgEditBtn" class="smooth-btn" onclick="app.toggleImageEditMode()"><i class="fa-solid fa-crop-simple"></i> Adjust</button>
            <button class="smooth-btn" onclick="ui.toggleModal('dataModal')"><i class="fa-solid fa-database"></i> Data</button>
            <button class="smooth-btn primary" onclick="ui.toggleModal('addModal')"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid-container custom-scrollbar" id="carGrid">
        <!-- Cars injected here -->
    </div>

    <!-- VEHICLE PROFILE OVERLAY -->
    <div class="overlay" id="detailOverlay">
        <div class="detail-panel">
            <button class="close-btn" onclick="ui.closeDetail()"><i class="fa-solid fa-xmark"></i></button>
            
            <div class="detail-img-box"><img id="dtImg" class="w-full h-full object-cover"><div class="absolute bottom-4 left-4 bg-black/60 px-3 py-1 rounded-lg text-xs font-bold backdrop-blur" id="dtCat">Category</div></div>
            
            <div class="detail-info relative overflow-hidden">
                <h1 id="dtName">Car Name</h1>
                <h2 id="dtReal">Real Name</h2>
                
                <div class="mastery-header">
                    <div class="text-xs font-bold uppercase">Vehicle Mastery</div>
                    <div class="mastery-icon rank-iron" id="carRankIcon">
                        <img id="carRankImg" src="" alt="Mastery">
                    </div>
                </div>
                <div class="car-xp-bar"><div class="car-xp-fill" id="dtXpFill"></div></div>
                
                <div class="stat-row">
                    <div class="big-stat editable" onclick="app.editMileage()">
                        <div class="big-stat-val" id="dtMiles">0</div>
                        <input type="number" id="dtMilesInput" class="stat-input" step="0.1" onblur="app.saveMileage()" onkeydown="if(event.key==='Enter') this.blur()">
                        <div class="big-stat-label">Miles Driven <i class="fa-solid fa-pen text-[9px] opacity-50 ml-1"></i></div>
                    </div>
                    <div class="big-stat">
                        <div class="big-stat-val text-red-400" id="dtCrashes">0</div>
                        <div class="big-stat-label">Incidents</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button class="smooth-btn primary justify-center" onclick="app.editMileage()"><i class="fa-solid fa-gauge-high"></i> Odometer</button>
                    <button class="smooth-btn active-mode justify-center" onclick="app.toggleCarTasks()"><i class="fa-solid fa-clipboard-list"></i> Vehicle Tasks</button>
                    <button class="smooth-btn justify-center" onclick="app.editActiveCar()"><i class="fa-solid fa-pen"></i> Edit</button>
                    <button class="smooth-btn danger justify-center" onclick="app.triggerDelete()"><i class="fa-solid fa-trash"></i> Sell</button>
                </div>

                <!-- SLIDING TASK PANEL -->
                <div class="car-tasks-panel" id="carTasksPanel">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Active Contracts</h3>
                        <button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white hover:text-black transition" onclick="app.toggleCarTasks()"><i class="fa-solid fa-arrow-left"></i></button>
                    </div>
                    <div id="carTaskList" class="flex-1 overflow-y-auto custom-scrollbar"></div>
                    <button class="smooth-btn w-full justify-center mt-4" onclick="app.refreshCarTasks()">Refresh Contracts</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LEVEL UP OVERLAY -->
    <div id="lvlUpOverlay">
        <div class="lvl-up-card">
            <div class="lvl-glow"></div>
            <div class="text-[var(--accent)] text-2xl font-bold tracking-[5px] mb-4">LEVEL UP</div>
            <div class="text-8xl font-black text-white mb-2" id="lvlUpNum">2</div>
            <div class="text-white/50 font-bold uppercase tracking-widest">
                <span id="lvlUpTitle">IRON</span> <span id="lvlUpTier">II</span>
            </div>
            <button class="smooth-btn primary mt-8 mx-auto" onclick="document.getElementById('lvlUpOverlay').classList.remove('active')">CONTINUE</button>
        </div>
    </div>

    <!-- CONFIRMATION & MODALS -->
    <div class="overlay" id="confirmModal">
        <div class="detail-panel" style="width: 400px; padding: 30px; display: block; text-align: center;">
            <i class="fa-solid fa-circle-exclamation text-4xl text-red-500 mb-4"></i>
            <h2 class="text-xl font-bold mb-2">Sell Vehicle?</h2>
            <p class="text-xs opacity-50 mb-6">This action cannot be undone. All stats and XP for this car will be lost.</p>
            <div class="flex gap-3 justify-center">
                <button class="smooth-btn" onclick="ui.toggleModal('confirmModal')">Cancel</button>
                <button class="smooth-btn danger" onclick="app.deleteActiveCar()">Confirm Sale</button>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fa-solid fa-circle-check toast-icon"></i><div class="toast-msg" id="toastMsg">Notification</div></div>

    <div class="overlay" id="dataModal">
        <div class="detail-panel" style="width: 600px; display: block; padding: 30px;">
            <button class="close-btn" onclick="ui.toggleModal('dataModal')"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-2xl font-bold mb-6">System Data</h2>
            <div class="border border-white/10 rounded-xl p-4 mb-4 text-center cursor-pointer hover:bg-white/5 transition border-dashed" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-file-arrow-up text-2xl mb-2 text-[var(--accent)]"></i>
                <div class="text-xs font-bold">Click to Upload Backup File</div>
                <div class="text-[10px] opacity-50" id="fileName">No file selected</div>
                <input type="file" id="fileInput" style="display:none;" accept=".json" onchange="app.handleFileSelect(this)">
            </div>
            <div class="flex gap-4 mb-4">
                <button class="smooth-btn primary flex-1 justify-center" onclick="app.exportData()"><i class="fa-solid fa-download"></i> Export JSON</button>
                <button class="smooth-btn flex-1 justify-center" onclick="app.importData()"><i class="fa-solid fa-upload"></i> Load from Text</button>
            </div>
            <p class="text-xs opacity-50 mb-2">Or paste JSON text below:</p>
            <textarea id="jsonArea" class="w-full h-32 bg-white/5 border border-white/10 rounded-xl p-3 text-xs font-mono outline-none resize-none"></textarea>
        </div>
    </div>

    <div class="overlay" id="addModal">
        <div class="detail-panel" style="width: 500px; display: block; padding: 30px;">
            <button class="close-btn" onclick="ui.toggleModal('addModal')"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-2xl font-bold mb-4">Manage Vehicle</h2>
            <form id="carForm" class="flex flex-col gap-3">
                <input type="hidden" id="inpId">
                <input type="text" id="inpName" placeholder="In-Game Name" class="bg-white/5 border border-white/10 p-3 rounded-xl outline-none text-white font-bold">
                <input type="text" id="inpReal" placeholder="Real Name (Optional)" class="bg-white/5 border border-white/10 p-3 rounded-xl outline-none text-white">
                <input type="text" id="inpCat" placeholder="Category" class="bg-white/5 border border-white/10 p-3 rounded-xl outline-none text-white">
                <div class="flex flex-col">
                    <input type="text" id="inpImg" placeholder="Image URL" class="bg-white/5 border border-white/10 p-3 rounded-xl outline-none text-white" oninput="app.updatePreview()">
                    <div class="img-edit-container" id="imgEditBox">
                        <div class="drag-hint">DRAG TO MOVE</div>
                        <img id="inpPreview" class="img-preview" src="">
                    </div>
                </div>
                <button type="button" class="smooth-btn primary justify-center mt-2" onclick="app.saveCar()">Save Vehicle</button>
            </form>
        </div>
    </div>

    <script>
        const CAR_QUESTS = [
            "Drive 10 Miles", "Reach Top Speed on Highway", "Perform an Oil Change (RP)", "Wash at Car Wash", 
            "Park at Casino Valet", "Transport VIP Passenger", "Night Drive (5 Miles)", "Win a Drag Race", 
            "Refuel to Full", "Escape Police Chase", "Drive in First Person", "Attend Car Meet", 
            "Inspect Engine Bay", "Drive Off-Road", "0 Crashes for 20 Mins"
        ];

        // --- EXPANDED RANK SYSTEM ---
        const RANKS = [
            { name: "IRON", key: "iron" },
            { name: "BRONZE", key: "bronze" },
            { name: "SILVER", key: "silver" },
            { name: "GOLD", key: "gold" },
            { name: "PLATINUM", key: "platinum" },
            { name: "EMERALD", key: "emerald" },
            { name: "SAPPHIRE", key: "sapphire" },
            { name: "AMETHYST", key: "amethyst" },
            { name: "RUBY", key: "ruby" },
            { name: "TOPAZ", key: "topaz" },
            { name: "OBSIDIAN", key: "obsidian" },
            { name: "CHROMA", key: "chroma" }
        ];

        // --- CUSTOM ASSET SYSTEM ---
        // PASTE YOUR CUSTOM IMAGE URLS HERE
        const RANK_ASSETS = {
            'iron': { 
                wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', 
                tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' 
            },
            'bronze':  { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'silver':  { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'gold':    { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'platinum': { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'emerald': { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'sapphire': { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'amethyst': { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'ruby':    { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'topaz':   { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'obsidian': { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' },
            'chroma': { wheel: 'https://cdn-icons-png.flaticon.com/512/31/31604.png', tire: 'https://cdn-icons-png.flaticon.com/512/5219/5219258.png' }
        };

        class App {
            constructor() {
                this.data = { cars: [], user: { xp: 0, level: 1 } };
                this.activeCar = null;
                this.isImageEditMode = false;
                this.drag = { active: false, startX: 0, startY: 0, initialPos: {x:50, y:50}, targetId: null };
                this.load();
                if(this.data.cars.length === 0) this.data.cars = [{ id: '1', name: '2017 Pagani Zonda HP', real: 'Pagani', cat: 'Supercar', img: '', miles: 120, incidents: 0, xp: 500, imgPos: '50% 50%', quests: [] }];
                this.renderGrid();
                this.updateGlobalStats();
                this.initDragLogic();
            }

            save() { localStorage.setItem('okgarage_v1', JSON.stringify(this.data)); }
            load() { const s = localStorage.getItem('okgarage_v1'); if(s) this.data = JSON.parse(s); }

            // --- CALCULATE RANK & TIER (I, II, III, IV) ---
            getRankInfo(lvl) {
                // Defines how many levels per Rank. 
                // E.g., 5 levels per rank (1-5 = Iron, 6-10 = Bronze)
                const levelsPerRank = 5;
                const totalRanks = RANKS.length;
                
                // Calculate which Rank Index
                // Level 1-5 -> Index 0 (Iron)
                let rankIndex = Math.floor((lvl - 1) / levelsPerRank);
                if (rankIndex >= totalRanks) rankIndex = totalRanks - 1; // Cap at max
                
                const rankData = RANKS[rankIndex];
                
                // Calculate Tier (I, II, III, IV, V)
                // Modulo math to cycle 1-5
                const tierNum = ((lvl - 1) % levelsPerRank) + 1;
                const tierRoman = this.toRoman(tierNum);
                
                return { 
                    name: rankData.name, 
                    key: rankData.key,
                    tier: tierRoman
                };
            }

            toRoman(num) {
                const roman = { 1:'I', 2:'II', 3:'III', 4:'IV', 5:'V' };
                return roman[num] || 'I';
            }

            updateGlobalStats() {
                const u = this.data.user;
                const nextLvlXp = u.level * 1000;
                const pct = (u.xp / nextLvlXp) * 100;
                
                document.getElementById('mainLvl').innerText = u.level;
                document.getElementById('mainXpFill').style.width = `${Math.min(100, pct)}%`;
                
                // Get Rank Info
                const rank = this.getRankInfo(u.level);
                
                // Update Text
                document.getElementById('rankTitle').innerText = rank.name;
                document.getElementById('rankTier').innerText = rank.tier;
                
                // Update CSS Color Theme
                const iconBox = document.getElementById('mainRankIcon');
                // Remove old rank classes
                RANKS.forEach(r => iconBox.classList.remove(`rank-${r.key}`));
                iconBox.classList.add(`rank-${rank.key}`);
                
                // Update Image
                const assets = RANK_ASSETS[rank.key];
                if(assets) document.getElementById('mainRankImg').src = assets.wheel;
            }

            updateCarXpUI() {
                if(!this.activeCar) return;
                // Car Level: Every 1000 XP = 1 Level
                const carLvl = Math.floor(this.activeCar.xp / 1000) + 1;
                const progress = (this.activeCar.xp % 1000) / 10; 
                
                document.getElementById('dtXpFill').style.width = `${progress}%`;
                
                const rank = this.getRankInfo(carLvl);
                const iconBox = document.getElementById('carRankIcon');
                
                RANKS.forEach(r => iconBox.classList.remove(`rank-${r.key}`));
                iconBox.classList.add(`rank-${rank.key}`);
                
                const assets = RANK_ASSETS[rank.key];
                if(assets) document.getElementById('carRankImg').src = assets.tire;
            }

            gainGlobalXp(amt) {
                this.data.user.xp += amt;
                let req = this.data.user.level * 1000;
                let leveledUp = false;
                
                while(this.data.user.xp >= req) {
                    this.data.user.xp -= req; 
                    this.data.user.level++;
                    req = this.data.user.level * 1000; 
                    leveledUp = true;
                }
                
                if(leveledUp) this.showLevelUp();
                this.updateGlobalStats();
            }

            showLevelUp() {
                const ov = document.getElementById('lvlUpOverlay');
                const rank = this.getRankInfo(this.data.user.level);
                
                document.getElementById('lvlUpNum').innerText = this.data.user.level;
                document.getElementById('lvlUpTitle').innerText = rank.name;
                document.getElementById('lvlUpTier').innerText = rank.tier;
                
                ov.classList.add('active');
            }

            // ... (Rest of logic remains same: Quest, Car, Drag, Save) ...
            
            // Re-pasting standard logic for completeness in this block
            refreshCarTasks() {
                if(!this.activeCar) return;
                this.activeCar.quests = [];
                for(let i=0; i<3; i++) {
                    const txt = CAR_QUESTS[Math.floor(Math.random() * CAR_QUESTS.length)];
                    this.activeCar.quests.push({ txt: txt, xp: 150, done: false, id: Date.now()+i });
                }
                this.save(); this.renderCarTasks();
            }
            renderCarTasks() {
                const list = document.getElementById('carTaskList'); list.innerHTML = "";
                if(!this.activeCar.quests) this.refreshCarTasks();
                this.activeCar.quests.forEach(q => {
                    const el = document.createElement('div'); el.className = `task-item ${q.done ? 'opacity-50' : ''}`;
                    el.innerHTML = `<div><div class="font-bold text-sm">${q.txt}</div><div class="text-[10px] text-[var(--accent)] font-bold">+${q.xp} XP</div></div>${!q.done ? `<button class="smooth-btn" style="padding:4px 10px; font-size:10px;" onclick="app.completeCarTask(${q.id})">Done</button>` : '<i class="fa-solid fa-check text-green-400"></i>'}`;
                    list.appendChild(el);
                });
            }
            completeCarTask(id) {
                const q = this.activeCar.quests.find(x => x.id === id);
                if(q && !q.done) { q.done = true; this.gainGlobalXp(q.xp); this.activeCar.xp += q.xp; this.updateCarXpUI(); this.renderCarTasks(); this.save(); ui.showToast(`Contract Complete: +${q.xp} XP`); }
            }
            toggleCarTasks() { const p = document.getElementById('carTasksPanel'); if(p.classList.contains('open')) p.classList.remove('open'); else { this.renderCarTasks(); p.classList.add('open'); } }
            openDetail(id) {
                this.activeCar = this.data.cars.find(c => c.id === id);
                if(!this.activeCar) return;
                document.getElementById('carTasksPanel').classList.remove('open');
                document.getElementById('dtName').innerText = this.activeCar.name;
                const showReal = this.activeCar.real && this.activeCar.real !== this.activeCar.name;
                document.getElementById('dtReal').innerText = showReal ? this.activeCar.real : "";
                document.getElementById('dtCat').innerText = this.activeCar.cat || "Unknown";
                document.getElementById('dtMiles').innerText = this.activeCar.miles.toFixed(1);
                document.getElementById('dtMilesInput').value = this.activeCar.miles.toFixed(1);
                document.getElementById('dtCrashes').innerText = this.activeCar.incidents;
                if(this.activeCar.img) { document.getElementById('dtImg').src = this.activeCar.img; document.getElementById('dtImg').style.objectPosition = 'center'; } else document.getElementById('dtImg').src = "";
                this.updateCarXpUI(); document.getElementById('detailOverlay').classList.add('active');
            }
            toggleImageEditMode() {
                this.isImageEditMode = !this.isImageEditMode;
                const btn = document.getElementById('imgEditBtn');
                if(this.isImageEditMode) { document.body.classList.add('edit-mode'); btn.classList.add('active-mode'); btn.innerHTML = '<i class="fa-solid fa-check"></i> Done'; } 
                else { document.body.classList.remove('edit-mode'); btn.classList.remove('active-mode'); btn.innerHTML = '<i class="fa-solid fa-crop-simple"></i> Adjust'; this.save(); }
            }
            initDragLogic() {
                window.addEventListener('mousedown', (e) => {
                    if(!this.isImageEditMode) { const box = e.target.closest('#imgEditBox'); if (box) { const img = box.querySelector('img'); e.preventDefault(); this.drag.active = true; this.drag.startX = e.clientX; this.drag.startY = e.clientY; this.drag.imgEl = img; this.drag.targetId = 'PREVIEW'; const style = img.style.objectPosition || '50% 50%'; const parts = style.split(' '); this.drag.initialPos = { x: parseFloat(parts[0]), y: parseFloat(parts[1]) }; } return; }
                    const card = e.target.closest('.car-card'); if(!card) return; const img = card.querySelector('.bg-img'); if(!img) return;
                    e.preventDefault(); this.drag.active = true; this.drag.startX = e.clientX; this.drag.startY = e.clientY; this.drag.targetId = card.getAttribute('data-id'); this.drag.imgEl = img; const style = img.style.objectPosition || '50% 50%'; const parts = style.split(' '); this.drag.initialPos = { x: parseFloat(parts[0]), y: parseFloat(parts[1]) };
                });
                window.addEventListener('mousemove', (e) => {
                    if(!this.drag.active || !this.drag.imgEl) return; e.preventDefault();
                    const dx = e.clientX - this.drag.startX; const dy = e.clientY - this.drag.startY; const sensitivity = 0.2; 
                    let newX = this.drag.initialPos.x - (dx * sensitivity); let newY = this.drag.initialPos.y - (dy * sensitivity); newX = Math.max(0, Math.min(100, newX)); newY = Math.max(0, Math.min(100, newY));
                    this.drag.imgEl.style.objectPosition = `${newX}% ${newY}%`;
                    if(this.drag.targetId !== 'PREVIEW') { const car = this.data.cars.find(c => c.id === this.drag.targetId); if(car) car.imgPos = `${newX}% ${newY}%`; }
                });
                window.addEventListener('mouseup', () => { this.drag.active = false; this.drag.imgEl = null; });
            }
            updatePreview() { const url = document.getElementById('inpImg').value; const img = document.getElementById('inpPreview'); if(url) img.src = url; else img.src = ""; }
            renderGrid() {
                const grid = document.getElementById('carGrid'); grid.innerHTML = "";
                this.data.cars.forEach(car => {
                    const el = document.createElement('div'); el.className = 'car-card group'; el.setAttribute('data-id', car.id); el.onclick = () => { if(!this.isImageEditMode) this.openDetail(car.id); };
                    const showReal = car.real && car.real.trim() !== "" && car.real !== car.name; const posStyle = car.imgPos ? `object-position: ${car.imgPos}` : '';
                    el.innerHTML = `${car.img ? `<img src="${car.img}" class="bg-img" style="${posStyle}">` : `<div class="bg-img bg-white/5 flex items-center justify-center"><i class="fa-solid fa-car text-4xl opacity-20"></i></div>`}<div class="card-gradient"></div><div class="card-content"><div class="text-group"><div class="card-name">${car.name}</div>${showReal ? `<div class="card-real">${car.real}</div>` : ''}</div><div class="card-stats"><div class="stat-badge"><i class="fa-solid fa-road text-[var(--accent)]"></i> ${car.miles.toFixed(1)} mi</div><div class="stat-badge"><i class="fa-solid fa-star text-yellow-400"></i> ${car.xp} XP</div>${car.incidents > 0 ? `<div class="stat-badge text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> ${car.incidents}</div>` : ''}</div></div>`;
                    grid.appendChild(el);
                });
            }
            editMileage() { const display = document.getElementById('dtMiles'); const input = document.getElementById('dtMilesInput'); display.style.display = 'none'; input.style.display = 'block'; input.focus(); }
            saveMileage() {
                const display = document.getElementById('dtMiles'); const input = document.getElementById('dtMilesInput'); const newVal = parseFloat(input.value);
                if(!isNaN(newVal) && this.activeCar) {
                    const diff = newVal - this.activeCar.miles;
                    if(diff > 0) {
                        this.activeCar.miles = newVal; const earnedXp = Math.floor(diff * 5); this.activeCar.xp += earnedXp; this.gainGlobalXp(earnedXp); ui.showToast(`+${diff.toFixed(1)} miles. +${earnedXp} XP`);
                    } else { this.activeCar.miles = newVal; }
                    this.save(); display.innerText = this.activeCar.miles.toFixed(1); this.updateCarXpUI(); this.renderGrid();
                }
                display.style.display = 'block'; input.style.display = 'none';
            }
            saveCar() {
                const id = document.getElementById('inpId').value; const name = document.getElementById('inpName').value; const real = document.getElementById('inpReal').value; const cat = document.getElementById('inpCat').value; const img = document.getElementById('inpImg').value; const imgPos = document.getElementById('inpPreview').style.objectPosition || '50% 50%';
                if(id) { const idx = this.data.cars.findIndex(c => c.id === id); if(idx > -1) { this.data.cars[idx].name = name; this.data.cars[idx].real = real; this.data.cars[idx].cat = cat; this.data.cars[idx].img = img; this.data.cars[idx].imgPos = imgPos; } } else { this.data.cars.push({ id: crypto.randomUUID(), name, real, cat, img, imgPos, miles:0, incidents:0, xp:0, quests:[] }); }
                this.save(); this.renderGrid(); ui.toggleModal('addModal'); if(this.activeCar && this.activeCar.id === id) this.openDetail(id); ui.showToast("Vehicle Saved.");
            }
            editActiveCar() {
                if(!this.activeCar) return;
                document.getElementById('inpId').value = this.activeCar.id; document.getElementById('inpName').value = this.activeCar.name; document.getElementById('inpReal').value = this.activeCar.real || ""; document.getElementById('inpCat').value = this.activeCar.cat || ""; document.getElementById('inpImg').value = this.activeCar.img || ""; const prev = document.getElementById('inpPreview'); prev.src = this.activeCar.img || ""; prev.style.objectPosition = this.activeCar.imgPos || '50% 50%'; ui.closeDetail(); ui.toggleModal('addModal');
            }
            triggerDelete() { if(!this.activeCar) return; ui.closeDetail(); ui.toggleModal('confirmModal'); }
            deleteActiveCar() { if(!this.activeCar) return; this.data.cars = this.data.cars.filter(c => c.id !== this.activeCar.id); this.save(); this.renderGrid(); ui.toggleModal('confirmModal'); ui.showToast("Vehicle Sold."); }
            exportData() { const s = JSON.stringify(this.data); document.getElementById('jsonArea').value = s; const blob = new Blob([s], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `okgarage_backup_${Date.now()}.json`; a.click(); }
            importData() { try { const val = document.getElementById('jsonArea').value; if(val) this.loadData(JSON.parse(val)); } catch(e) { ui.showToast("Error parsing JSON text."); } }
            handleFileSelect(input) { const file = input.files[0]; if(!file) return; document.getElementById('fileName').innerText = file.name; const reader = new FileReader(); reader.onload = (e) => { try { this.loadData(JSON.parse(e.target.result)); } catch(err) { ui.showToast("Corrupt File."); } }; reader.readAsText(file); }
            loadData(d) {
                if(d.cars && d.user) { this.data = d; this.save(); this.renderGrid(); this.updateGlobalStats(); ui.showToast("System Restored."); ui.toggleModal('dataModal'); } else if(Array.isArray(d)) { d.forEach(c => { if(!c.id) c.id = crypto.randomUUID(); if(!c.imgPos) c.imgPos = '50% 50%'; if(!c.quests) c.quests=[]; this.data.cars.push(c); }); this.save(); this.renderGrid(); ui.showToast(`Imported ${d.length} cars.`); ui.toggleModal('dataModal'); } else ui.showToast("Invalid Data.");
            }
        }

        const ui = {
            toggleModal: (id) => { const m = document.getElementById(id); m.classList.toggle('active'); },
            closeDetail: () => document.getElementById('detailOverlay').classList.remove('active'),
            showToast: (msg) => { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 3000); }
        };

        const app = new App();
    </script>
</body>
</html>